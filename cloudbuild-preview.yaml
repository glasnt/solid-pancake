steps:
    - name: 'gcr.io/cloud-builders/docker'
      args: ['build', '-t', 
             'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${_PR_NUMBER}-${SHORT_SHA}', '.']

    - name: 'gcr.io/cloud-builders/docker'
      args: ['push', 
             'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${_PR_NUMBER}-${SHORT_SHA}' ]


    # DEBUG -- fresh build of set-check-status each time for testing.
    #- id: 'debug  '
    #  name: 'gcr.io/cloud-builders/docker'
    #  args: ['build', '-t', 
    #         'gcr.io/${PROJECT_ID}/set-check-status:$SHORT_SHA', 'set-check-status']
    #- id: 'debug2  '
    #  name: 'gcr.io/cloud-builders/docker'
    #  args: ['push', 
    #         'gcr.io/${PROJECT_ID}/set-check-status:$SHORT_SHA']
    # ENDDEBUG

    - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
      entrypoint: 'bash'
      args: 
        - '-c'
        - |
          gcloud run deploy ${_SERVICE_NAME} --platform managed --region ${_REGION} --image gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${_PR_NUMBER}-${SHORT_SHA} --revision-suffix=pr-${_PR_NUMBER}-${SHORT_SHA} --no-traffic
          echo $(gcloud run services describe ${_SERVICE_NAME} --platform managed --region ${_REGION} --format "value(status.address.url)") > /workspace/url.txt
          cat /workspace/url.txt

    - name: 'gcr.io/${PROJECT_ID}/set-check-status' #:$SHORT_SHA'
      entrypoint: bash
      args: 
        - '-c'
        - |
          cat /workspace/url.txt 
          echo python /app/set-check-status.py \
            --project-id ${PROJECT_ID} \
            --repo-name ${_GITHUB_USER}/${REPO_NAME} \
            --commit-sha ${SHORT_SHA} \
             --service-url $(cat /workspace/url.txt) \
            --target-tag pr-${_PR_NUMBER}

          python /app/set-check-status.py \
            --project-id ${PROJECT_ID} \
            --repo-name ${_GITHUB_USER}/${REPO_NAME} \
            --commit-sha ${SHORT_SHA} \
            --service-url $(cat /workspace/url.txt) \
            --target-tag pr-${_PR_NUMBER}


substitutions:
    _SERVICE_NAME: solid-pancake
    #    _PR_NUMBER: "2"
    _REGION: us-central1
    _GITHUB_USER: glasnt

